<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ritik Compiler</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- CodeMirror CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>

    <!-- Theme -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">

    <!-- Addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>

    <!-- Folding -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/brace-fold.min.js"></script>

    <!-- Language Modes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>

    <style>
        .CodeMirror {
            height: 500px !important;
            border-radius: 10px;
        }
        .hidden { display: none !important; }
    </style>
</head>

<body class="bg-black">
<div class="row m-3">

    <div class="col">

        <div class="d-flex gap-3 align-items-center mb-2 bg-dark rounded p-2">
            <div class="col-md-4">
                <select id="languageBox" class="form-select">
                    <option value="text/x-java">Java</option>
                    <option value="python">Python</option>
                    <option value="text/x-csrc">C</option>
                    <option value="text/x-c++src">C++</option>
                    <option value="javascript">JavaScript</option>
                </select>
            </div>

            <button id="runBtn" class="btn btn-success">
                <i class="bi bi-play-fill"></i> Run
            </button>
        </div>

        <textarea id="editor"></textarea>

    </div>

    <div class="col d-flex flex-column rounded bg-dark px-4">

        <div id="inputContainer" class="h-50 hidden">
            <label class="text-light mt-4 mb-2">Input</label>
            <textarea id="inputBox" class="form-control h-75"></textarea>
        </div>

        <div id="outputContainer" class="h-50 hidden">
            <label class="text-light mt-3 mb-2">Output</label>
            <textarea id="outputBox" class="form-control h-75"></textarea>
        </div>

    </div>

</div>

<script>
let BACKEND_URL = "https://back-api-ritik-ds62.onrender.com/run";

// ---------- CodeMirror Setup ----------
let editor = CodeMirror.fromTextArea(document.querySelector("#editor"), {
    theme: "dracula",
    mode: "text/x-java",
    autoCloseBrackets: true,
    matchBrackets: true,
    lineNumbers: true,
    foldGutter: true,
    gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
});

// Mode Switch
const modes = {
    "text/x-java": "text/x-java",
    "python": "python",
    "text/x-csrc": "text/x-csrc",
    "text/x-c++src": "text/x-c++src",
    "javascript": "javascript"
};

document.querySelector("#languageBox").addEventListener("change", function () {
    editor.setOption("mode", modes[this.value]);
});

// Detect Java Inputs
function getJavaInputCount(code) {
    let matches = code.match(/next(Int|Double|Float|Long|Short|Byte|Boolean)?\(/g);
    return matches ? matches.length : 0;
}

let requiredInputs = 0;
let waitingForInput = false;

let inputContainer = document.getElementById("inputContainer");
let outputContainer = document.getElementById("outputContainer");

// ---------- RUN BUTTON ----------
document.querySelector("#runBtn").addEventListener("click", function () {

    let runBtn = document.querySelector("#runBtn");
    runBtn.style.backgroundColor = "red";
    runBtn.style.borderColor = "red";
    runBtn.disabled = true;

    waitingForInput = true;

    requiredInputs = getJavaInputCount(editor.getValue());

    inputContainer.classList.remove("hidden");
    outputContainer.classList.add("hidden");

    document.querySelector("#inputBox").value = "";
    document.querySelector("#outputBox").value = "";

    document.querySelector("#inputBox").focus();
});

// ---------- INPUT LISTEN ----------
document.querySelector("#inputBox").addEventListener("keydown", async function (e) {

    if (waitingForInput && e.key === "Enter") {

        setTimeout(async () => {

            let lines = document.querySelector("#inputBox").value.trim().split("\n").length;

            if (lines === requiredInputs) {
                waitingForInput = false;
                await runCode();
            }

        }, 50);
    }
});

// ---------- RUN CODE (BACKEND CALL) ----------
async function runCode() {

    let runBtn = document.querySelector("#runBtn");
    let code = editor.getValue();
    let input = document.querySelector("#inputBox").value;

    let response = await fetch(BACKEND_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            language: document.querySelector("#languageBox").value,
            code: code,
            input: input
        })
    });

    let data = await response.json();
    document.querySelector("#outputBox").value = data.output;

    outputContainer.classList.remove("hidden");

    runBtn.style.backgroundColor = "green";
    runBtn.style.borderColor = "green";
    runBtn.disabled = false;
}
</script>

</body>
</html>
